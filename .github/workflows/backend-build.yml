# Production-Ready Backend Build
#
# PURPOSE: Main workflow that orchestrates the backend build process
# WHY: Coordinates all sub-workflows in a logical order
# WHEN: Runs on every push/PR to backend code
#
# This is the main entry point for the backend build process.
# It coordinates three sub-workflows:
# 1. Database Setup: Ensures Supabase connection is ready
# 2. Rust Setup: Prepares the Rust environment
# 3. Build and Test: Builds and verifies the backend

name: Production Backend Build

# When to run this workflow - only when called by backend-ci.yml
on:
  workflow_call:

jobs:
  # Step 1: Setup Database
  setup-db:
    name: Setup Database Connection
    uses: ./.github/workflows/backend/database-setup.yml
    secrets:
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}

  # Step 2: Setup Rust Environment
  setup-rust:
    name: Setup Rust Environment
    uses: ./.github/workflows/backend/rust-setup.yml
    needs: setup-db

  # Step 3: Build and Test
  build:
    name: Build and Test Backend
    needs: [setup-db, setup-rust]
    uses: ./.github/workflows/backend/build-and-test.yml
    with:
      db_ready: ${{ needs.setup-db.outputs.db_ready }}
      rust_ready: ${{ needs.setup-rust.outputs.rust_ready }}